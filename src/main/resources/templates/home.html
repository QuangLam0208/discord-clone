<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Discord Clone</title>
    <link rel="stylesheet" href="/css/style.css?v=4">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <div class="app-layout" id="app" style="display: none;">

        <!-- Sidebar (Server Nav) -->
        <nav th:replace="~{fragments/server-nav :: server-nav}"></nav>

        <!-- Channels Sidebar -->
        <aside th:replace="~{fragments/channel-sidebar :: channel-sidebar}"></aside>

        <!-- Chat Content -->
        <main th:replace="~{fragments/chat-content :: chat-content}"></main>
    </div>

    <!-- Modals & Context Menus -->
    <div th:replace="~{fragments/modals :: modals}"></div>

    <script src="/js/api.js?v=1"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <!-- Load Modules (Order matters) -->
    <script src="/js/home.js?v=2"></script> <!-- Main State & Init -->
    <script src="/js/user.js?v=2"></script>
    <script src="/js/server-list.js?v=1"></script>
    <script src="/js/server-settings.js?v=1"></script>
    <script src="/js/server-overview.js?v=1"></script>
    <script src="/js/server-bans.js?v=1"></script>
    <script src="/js/server-audit.js?v=1"></script>
    <script src="/js/server-roles.js?v=1"></script>
    <script src="/js/server-members.js?v=1"></script>
    <script src="/js/channel.js?v=2"></script>
    <script src="/js/chat.js?v=2"></script>
    <script src="/js/upload.js?v=2"></script>
    <script src="/js/invite.js?v=1"></script>
    <script>
        // 1. Logic Switch View
        function switchToDM() { toggleViews('dm'); }
        function switchToServer(el) {
            document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            toggleViews('server');
        }
        function toggleViews(type) {
            const isServer = type === 'server';
            document.getElementById('server-channels-view').style.display = isServer ? 'flex' : 'none';
            document.getElementById('dm-channels-view').style.display = isServer ? 'none' : 'flex';
            document.getElementById('server-chat-view').style.display = isServer ? 'flex' : 'none';
            document.getElementById('dm-chat-view').style.display = isServer ? 'none' : 'flex';
        }

        // 2. Modal Helpers
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // 3. Close when click outside
        window.onclick = function (e) {
            if (e.target.classList.contains('modal-overlay')) e.target.classList.remove('active');
            if (!e.target.closest('.context-menu') && !e.target.closest('.channel-list')) {
                document.getElementById('context-menu').classList.remove('visible');
            }
        }

        // 4. Context Menu
        const channelArea = document.getElementById('server-channel-area');
        const ctxMenu = document.getElementById('context-menu');
        if (channelArea) {
            channelArea.addEventListener('contextmenu', e => {
                e.preventDefault();
                ctxMenu.style.top = `${e.clientY}px`;
                ctxMenu.style.left = `${e.clientX}px`;
                ctxMenu.classList.add('visible');
            });
        }

        // 5. Triggers
        function triggerInvite() { ctxMenu.classList.remove('visible'); if (window.openInviteModal) window.openInviteModal(); }
        function triggerCreateChannelRoot() { ctxMenu.classList.remove('visible'); openModal('createChannelRootModal'); }
        function triggerCreateCategory() { ctxMenu.classList.remove('visible'); openModal('createCategoryModal'); }

        switchToDM();
    </script>
</body>

</html>