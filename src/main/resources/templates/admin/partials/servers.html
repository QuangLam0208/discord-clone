<div class="discord-admin-container" style="padding:0;">
    <div class="discord-header">
        <h1>Quản lý Server</h1>
        <form action="#" method="get" class="discord-search"
            onsubmit="event.preventDefault(); loadSection('servers', {keyword: this.keyword.value});">
            <label>
                <input type="text" name="keyword" th:value="${keyword}" placeholder="Tìm theo tên server...">
            </label>
            <button type="submit"><i class="fas fa-search"></i></button>
        </form>
    </div>

    <div class="discord-table-wrapper">
        <table class="discord-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên Server</th>
                    <th>Chủ sở hữu (Owner)</th>
                    <th>Thành viên</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="sv : ${servers}" th:attr="data-server-row=${sv.id}">
                    <td style="color:#b5bac1;font-family:monospace;" th:text="'#' + ${sv.id}">#1</td>
                    <td>
                        <div class="user-cell" style="cursor:pointer;" title="Xem chi tiết"
                            th:attr="onclick='openServerDetailModal(' + ${sv.id} + ')'">
                            <span th:text="${sv.name}" class="hover-underline">Server Name</span>
                        </div>
                    </td>
                    <td th:attr="data-server-owner=${sv.id}">
                        <span th:if="${sv.owner != null}" th:text="${sv.owner.username}"
                            style="color:#f2f3f5;font-weight:600;">Owner</span>
                        <span th:unless="${sv.owner != null}" style="color:#da373c;">No Owner</span>
                    </td>
                    <td>
                        <span class="badge-role member" style="background-color:#2b2d31;color:#b9bbbe;">
                            <i class="fas fa-user-friends"></i> <span
                                th:text="${sv.members != null ? sv.members.size() : 0}">0</span>
                        </span>
                    </td>
                    <td th:attr="data-server-status=${sv.id}">
                        <span th:switch="${sv.status}">
                            <span th:case="${T(hcmute.edu.vn.discord.entity.enums.ServerStatus).ACTIVE}"
                                class="badge-status active">Active</span>
                            <span th:case="${T(hcmute.edu.vn.discord.entity.enums.ServerStatus).FREEZE}"
                                class="badge-status freeze">Freeze</span>
                            <span th:case="${T(hcmute.edu.vn.discord.entity.enums.ServerStatus).SHADOW}"
                                class="badge-status shadow" style="background:#555;color:#bbb">Shadow</span>
                            <span th:case="*" class="badge-status active">Active</span>
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons-wrapper" style="position:relative;">
                            <button type="button" class="btn-mini edit" th:data-id="${sv.id}" th:data-name="${sv.name}"
                                onclick="openTransferModal(this.getAttribute('data-id'), this.getAttribute('data-name'))">
                                <i class="fas fa-right-left"></i> Chuyển
                            </button>
                            <button type="button" class="btn-mini warn" th:attr="data-id=${sv.id}"
                                onclick="toggleStatusMenu(this, this.getAttribute('data-id'))">
                                <i class="fas fa-triangle-exclamation"></i>
                            </button>
                            <button type="button" class="btn-mini ban" th:data-id="${sv.id}" th:data-name="${sv.name}"
                                onclick="openDeleteModal(this.getAttribute('data-id'), this.getAttribute('data-name'))">
                                <i class="fas fa-trash"></i>
                            </button>

                            <div class="status-menu" th:id="'status-menu-' + ${sv.id}">
                                <div class="status-menu-header">Gán trạng thái</div>
                                <button type="button" class="status-item active" data-status="ACTIVE"
                                    onclick="updateServerStatus(this.closest('[data-server-row]').getAttribute('data-server-row'), this.getAttribute('data-status'))">
                                    <i class="fas fa-circle-check"></i> ACTIVE
                                </button>
                                <button type="button" class="status-item freeze" data-status="FREEZE"
                                    onclick="updateServerStatus(this.closest('[data-server-row]').getAttribute('data-server-row'), this.getAttribute('data-status'))">
                                    <i class="fas fa-snowflake"></i> FREEZE
                                </button>
                                <button type="button" class="status-item shadow" data-status="SHADOW"
                                    style="color:#aaa;"
                                    onclick="updateServerStatus(this.closest('[data-server-row]').getAttribute('data-server-row'), this.getAttribute('data-status'))">
                                    <i class="fas fa-ghost"></i> SHADOW
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(servers)}">
                    <td colspan="6" class="muted" style="text-align:center;padding:40px;">
                        <i class="fas fa-search"></i> Không tìm thấy server nào.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="discord-pagination" th:if="${totalPages > 1}">
        <a th:if="${currentPage > 0}" href="javascript:void(0)" class="page-btn admin-pagination-link"
            data-section="servers" th:data-page="${currentPage - 1}" th:data-keyword="${keyword}">
            <i class="fas fa-chevron-left"></i> Trước
        </a>

        <span class="page-info">Trang <b th:text="${currentPage + 1}"></b> / <span
                th:text="${totalPages}"></span></span>

        <a th:if="${currentPage < totalPages - 1}" href="javascript:void(0)" class="page-btn admin-pagination-link"
            data-section="servers" th:data-page="${currentPage + 1}" th:data-keyword="${keyword}">
            Sau <i class="fas fa-chevron-right"></i>
        </a>
    </div>
</div>

<!-- Modals -->
<div id="deleteModal" class="modal-overlay">
    <div class="discord-modal">
        <div class="modal-header">
            <h2 class="danger-title">XÓA SERVER</h2>
        </div>
        <div class="modal-body">
            <input type="hidden" id="deleteServerId">
            <p class="confirm-text">Bạn có chắc chắn muốn xóa server <strong id="deleteServerName">...</strong> không?
            </p>
            <div class="discord-warning-box">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Hành động này không thể hoàn tác. Tất cả dữ liệu tin nhắn và kênh sẽ mất vĩnh viễn.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeModal('deleteModal')">Hủy bỏ</button>
            <button type="button" class="btn-danger-action" id="btnConfirmDelete">Xóa Server</button>
        </div>
    </div>
</div>

<div id="transferModal" class="modal-overlay" data-selected-member-id="">
    <div class="discord-modal" style="width:560px;">
        <div class="modal-header">
            <h2>Chuyển quyền sở hữu</h2>
            <div id="transferServerNameTitle" class="modal-subtitle server-name-title">Tên server</div>
        </div>
        <div class="modal-body">
            <input type="hidden" id="transferServerId">

            <div class="form-group" style="margin-bottom:8px;">
                <label>Chọn thành viên làm Owner mới</label>
                <div class="discord-search search-inline" style="margin-bottom:8px;">
                    <input type="text" id="transferMemberSearch" placeholder="Tìm theo username hoặc display name...">
                    <button type="button" class="search-btn-inline" onclick="filterTransferMemberList()"
                        aria-label="Tìm">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>

                <div id="transferMemberList"
                    style="max-height:260px; overflow:auto; background:#1e1f22; border:1px solid #3f4147; border-radius:6px;">
                </div>
                <div class="muted" id="transferMemberHint" style="margin-top:8px;">Chỉ thành viên của server này mới có
                    thể trở thành Owner.</div>
            </div>

            <div class="discord-warning-box">
                <i class="fas fa-exclamation-triangle"></i>
                <p><strong>Cảnh báo:</strong> Xác nhận sẽ chuyển quyền ngay lập tức. Owner cũ sẽ mất role ADMIN; Owner
                    mới sẽ được gán role ADMIN.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeModal('transferModal')">Hủy bỏ</button>
            <button type="button" class="btn-confirm" id="btnConfirmTransfer">Xác nhận chuyển</button>
        </div>
    </div>
</div>

<!-- Server Detail Modal -->
<div id="detailServerModal" class="modal-overlay">
    <div class="discord-modal" style="width:600px; max-width:90vw;">
        <div class="modal-header" style="border-bottom:none; padding-bottom:0;">
            <button type="button" class="btn-close" onclick="closeModal('detailServerModal')"
                style="float:right;background:none;border:none;color:#b9bbbe;font-size:20px;cursor:pointer;">&times;</button>
            <div style="display:flex; align-items:center; gap:12px;">
                <img id="detailServerIcon" src="/images/default.png"
                    style="width:48px;height:48px;border-radius:16px;object-fit:cover;">
                <div>
                    <h2 id="detailServerName" style="margin:0;font-size:20px;">Server Name</h2>
                    <div id="detailServerId" style="color:#b5bac1;font-size:12px;font-family:monospace;">ID: #1</div>
                </div>
            </div>
        </div>

        <div class="modal-body" style="padding-top:10px;">
            <!-- Status Badge -->
            <div style="margin-bottom:16px;">
                <span id="detailServerStatus" class="badge-status active">ACTIVE</span>
            </div>

            <!-- Description -->
            <div style="margin-bottom:16px;">
                <label style="color:#b5bac1;font-size:12px;font-weight:700;text-transform:uppercase;">Mô tả</label>
                <div id="detailServerDesc" style="color:#dbdee1;font-style:italic;">Không có mô tả</div>
            </div>

            <!-- Owner -->
            <div
                style="margin-bottom:16px; display:flex; gap:8px; align-items:center; background:#2b2d31; padding:8px 12px; border-radius:4px;">
                <i class="fas fa-crown" style="color:#faa61a;"></i>
                <div style="color:#b5bac1;font-size:12px;">Owner: <strong id="detailServerOwner"
                        style="color:#fff;">admin</strong></div>
            </div>

            <!-- Stats Grid -->
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:16px;">
                <div style="background:#2b2d31; padding:10px; border-radius:4px; text-align:center;">
                    <div style="color:#b5bac1;font-size:11px;text-transform:uppercase;">Thành viên</div>
                    <div id="detailMemberCount" style="color:#fff;font-size:18px;font-weight:bold;">0</div>
                </div>
                <div style="background:#2b2d31; padding:10px; border-radius:4px; text-align:center;">
                    <div style="color:#b5bac1;font-size:11px;text-transform:uppercase;">Kênh</div>
                    <div id="detailChannelCount" style="color:#fff;font-size:18px;font-weight:bold;">0</div>
                </div>
                <div style="background:#2b2d31; padding:10px; border-radius:4px; text-align:center;">
                    <div style="color:#b5bac1;font-size:11px;text-transform:uppercase;">Roles</div>
                    <div id="detailRoleCount" style="color:#fff;font-size:18px;font-weight:bold;">0</div>
                </div>
            </div>

            <!-- Lists (Tabs or simple dump) -->
            <div style="display:flex; gap:16px;">
                <!-- Members List -->
                <div style="flex:1;">
                    <label
                        style="color:#b5bac1;font-size:11px;font-weight:700;text-transform:uppercase; display:block; margin-bottom:4px;">Members
                        (Sample)</label>
                    <div id="detailMembersList"
                        style="background:#2b2d31; height:150px; overflow-y:auto; padding:8px; border-radius:4px; font-size:13px; color:#dbdee1;">
                        <!-- JS Insert -->
                    </div>
                </div>

                <!-- Channels & Roles -->
                <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
                    <div>
                        <label
                            style="color:#b5bac1;font-size:11px;font-weight:700;text-transform:uppercase; display:block; margin-bottom:4px;">Channels</label>
                        <div id="detailChannelsList"
                            style="background:#2b2d31; height:69px; overflow-y:auto; padding:8px; border-radius:4px; font-size:13px; color:#dbdee1;">
                        </div>
                    </div>
                    <div>
                        <label
                            style="color:#b5bac1;font-size:11px;font-weight:700;text-transform:uppercase; display:block; margin-bottom:4px;">Roles</label>
                        <div id="detailRolesList"
                            style="background:#2b2d31; height:69px; overflow-y:auto; padding:8px; border-radius:4px; font-size:13px; color:#dbdee1;">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>